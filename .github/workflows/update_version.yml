name: Update Version

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'pubspec.yaml'

jobs:
  update-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update pubspec.yaml
        id: update_version
        run: |
          COMMIT_COUNT=$(git rev-list --count HEAD)
          BUILD_NUMBER=$((COMMIT_COUNT + 1))
          VERSION_BASE=$(sed -n 's/^version: \([^+]*\).*/\1/p' pubspec.yaml)
          NEW_VERSION="$VERSION_BASE+$BUILD_NUMBER"
          CURRENT_VERSION=$(sed -n 's/^version: \(.*\)/\1/p' pubspec.yaml)
          
          if [ "$CURRENT_VERSION" = "$NEW_VERSION" ]; then
            echo "Version already correct. Skipping."
            echo "should_commit=false" >> $GITHUB_OUTPUT
          else
            echo "New version: $NEW_VERSION"
            sed -i "s|^version: .*|version: $NEW_VERSION|" pubspec.yaml
            echo "should_commit=true" >> $GITHUB_OUTPUT
          fi

      - name: Amend previous commit
        if: steps.update_version.outputs.should_commit == 'true'
        run: |
          AUTHOR_NAME=$(git log -1 --format='%an')
          AUTHOR_EMAIL=$(git log -1 --format='%ae')
          git config --local user.name "$AUTHOR_NAME"
          git config --local user.email "$AUTHOR_EMAIL"
          git add pubspec.yaml
          git commit --amend --no-edit

      - name: Force push
        if: steps.update_version.outputs.should_commit == 'true'
        run: git push origin ${{ github.ref_name }} --force
